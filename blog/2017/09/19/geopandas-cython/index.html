<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Joris Van den Bossche">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>GeoPandas developments: redesign and improved performance using Cython | Joris Van den Bossche</title>

	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="alternate" type="application/atom+xml" title="Joris Van den Bossche blog atom feed" href="/feeds/all.atom.xml" />
        <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="/theme/css/icons.css"/>
        <style>.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #60a0b0; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #007020; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #007020 } /* Comment.Preproc */
.highlight .c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.highlight .cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #007020 } /* Keyword.Pseudo */
.highlight .kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #902000 } /* Keyword.Type */
.highlight .m { color: #40a070 } /* Literal.Number */
.highlight .s { color: #4070a0 } /* Literal.String */
.highlight .na { color: #4070a0 } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.highlight .no { color: #60add5 } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #d55537; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #007020 } /* Name.Exception */
.highlight .nf { color: #06287e } /* Name.Function */
.highlight .nl { color: #002070; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #062873; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #bb60d5 } /* Name.Variable */
.highlight .ow { color: #007020; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #40a070 } /* Literal.Number.Float */
.highlight .mh { color: #40a070 } /* Literal.Number.Hex */
.highlight .mi { color: #40a070 } /* Literal.Number.Integer */
.highlight .mo { color: #40a070 } /* Literal.Number.Oct */
.highlight .sb { color: #4070a0 } /* Literal.String.Backtick */
.highlight .sc { color: #4070a0 } /* Literal.String.Char */
.highlight .sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #4070a0 } /* Literal.String.Double */
.highlight .se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #4070a0 } /* Literal.String.Heredoc */
.highlight .si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.highlight .sx { color: #c65d09 } /* Literal.String.Other */
.highlight .sr { color: #235388 } /* Literal.String.Regex */
.highlight .s1 { color: #4070a0 } /* Literal.String.Single */
.highlight .ss { color: #517918 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #bb60d5 } /* Name.Variable.Class */
.highlight .vg { color: #bb60d5 } /* Name.Variable.Global */
.highlight .vi { color: #bb60d5 } /* Name.Variable.Instance */
.highlight .il { color: #40a070 } /* Literal.Number.Integer.Long */</style>
        <style>body {
  margin: 0;
  padding: 0;
  font: 15px 'Source Sans Pro', sans-serif;
  line-height: 1.6em;
  color: #222;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
}
a {
  color: #007EE5;
  text-decoration: none;
}
a:hover {
  color: #007EE5;
  text-decoration: none;
}
header.main-header {
  background: none repeat scroll 0% 0% #205F29;
  margin-bottom: 0px;
}
header.main-header a {
  color: #fff;
}
header.main-header .container {
  max-width: 1000px;
}
header.main-header .container nav a:hover {
  background-color: #5C881C;
}
article {
  margin: 0;
}
article header.about {
  margin-bottom: 0px;
  padding-bottom: 0px;
}
article header {
  margin-bottom: 20px;
  padding-bottom: 20px;
}
article header h1 {
  margin-bottom: 2px;
  font-weight: 700;
  color: #000;
}
article header time {
  color: #9E9E9E;
  font-size: 0.85em;
  float: right;
}
article header time.left {
  color: #9E9E9E;
  font-size: 0.85em;
  float: left;
}
article div.social-links ul {
  padding: 0px;
}
article div.social-links li {
  display: inline;
  font-size: 20px;
}
article div.social-links li a {
  color: #000;
  padding: 10px;
}
article div.social-links li a:hover {
  color: #666;
  text-decoration: none;
}
article p {
  font-size: 16px;
  margin-bottom: 20px;
  line-height: 1.6em;
}
article p.note {
  background: #f5f5f5;
  border: 1px solid #ddd;
  padding: 0.533em 0.733em;
}
article p.update {
  background-color: #FEEFB3;
  border: 1px solid #e6e68a;
  padding: 0.533em 0.733em;
}
article p.alert {
  background-color: #ffe2e2;
  border: 1px solid #ffb2b2;
  padding: 0.533em 0.733em;
}
article ul,
article ol {
  margin-top: 0px;
  margin-bottom: 25px;
}
article li {
  font-size: 16px;
  line-height: 1.6em;
}
article a:hover {
  text-decoration: underline;
}
article blockquote {
  border-left: 2px solid #c7c7cc;
  color: #666;
  margin: 30px 0;
  padding: 0 0 0 25px;
}
article img {
  max-width: 100%;
}
article code {
  color: #333;
  background-color: #EEE;
  border-radius: 0;
  font-size: 13px;
}
article .meta {
  font-size: 11px;
}
article .meta a:hover {
  text-decoration: none;
}
article .meta div {
  margin-bottom: 20px;
  display: block;
}
article .meta a.tag {
  margin: 0 10px 10px 0;
  padding: 1px 12px;
  display: inline-block;
  font-size: 14px;
  color: rgba(0, 0, 0, 0.8);
  background: rgba(0, 0, 0, 0.05);
}
article .meta a.tag:hover {
  background: rgba(0, 0, 0, 0.15);
}
article .meta a.read_more,
article .meta a.comments_btn {
  font-size: 14px;
  font-weight: 800;
  padding: 10px 20px;
  color: #205F29;
  background: #FFF;
  border: 1px solid #205F29;
}
article .meta a.read_more:hover,
article .meta a.comments_btn:hover {
  color: #FFF;
  background: #5C881C;
}
.index {
  max-width: 700px;
}
.index article header h2 {
  font-size: 36px;
  margin-bottom: 2px;
  font-weight: 700;
}
.index article header h2 a {
  color: #000;
}
.index article header h2 a:hover {
  color: #007EE5;
  text-decoration: none;
}
.index .separator {
  padding: 40px 0 0 0;
  margin: 0 0 40px 0;
  height: 10px;
  border-bottom: solid 1px #CCC;
}
.index .pagination {
  display: block;
  margin-bottom: 100px;
}
.index .pagination .left {
  text-align: right;
}
.index .pagination .right {
  text-align: left;
}
.index .pagination a {
  display: inline-block;
  border: 2px solid #5C881C;
  margin: 0 5px;
  padding: 8px 20px;
  font-weight: bold;
  color: #5C881C;
}
.index .pagination a:hover {
  color: #FFF;
  background: #5C881C;
}
.post {
  max-width: 800px;
}
.post h2:before {
  content: "# ";
  font-weight: bold;
  color: #DDD;
}
.post h3:before {
  content: "## ";
  font-weight: bold;
  color: #DDD;
}
.post h4:before {
  content: "### ";
  font-weight: bold;
  color: #DDD;
}
.post article .meta {
  margin: 50px 0 100px;
}
.list {
  max-width: 700px;
}
.list ul.double-list {
  margin: 0 auto 60px;
  padding: 0;
  list-style-type: none;
}
.list ul.double-list li {
  padding: 5px 0;
}
.list ul.double-list li h2 {
  font-size: 1em;
  display: inline;
  font-weight: normal;
}
.list ul.double-list li span {
  font-family: sans-serif;
  text-transform: uppercase;
  text-align: right;
  float: right;
  padding-top: 3px;
  font-size: 12px;
  color: #999;
}
.full-width-content {
  padding-top: 10px;
  padding-left: 0px;
  padding-right: 0px;
  margin-left: -20px;
  margin-right: -20px;
}
.col-xs-1,
.col-sm-1,
.col-md-1,
.col-lg-1,
.col-xs-2,
.col-sm-2,
.col-md-2,
.col-lg-2,
.col-xs-3,
.col-sm-3,
.col-md-3,
.col-lg-3,
.col-xs-4,
.col-sm-4,
.col-md-4,
.col-lg-4,
.col-xs-5,
.col-sm-5,
.col-md-5,
.col-lg-5,
.col-xs-6,
.col-sm-6,
.col-md-6,
.col-lg-6,
.col-xs-7,
.col-sm-7,
.col-md-7,
.col-lg-7,
.col-xs-8,
.col-sm-8,
.col-md-8,
.col-lg-8,
.col-xs-9,
.col-sm-9,
.col-md-9,
.col-lg-9,
.col-xs-10,
.col-sm-10,
.col-md-10,
.col-lg-10,
.col-xs-11,
.col-sm-11,
.col-md-11,
.col-lg-11,
.col-xs-12,
.col-sm-12,
.col-md-12,
.col-lg-12 {
  padding-right: 0px;
  padding-left: 0px;
}

a.headerlink:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .headerlink,
h2:hover .headerlink,
h3:hover .headerlink,
h4:hover .headerlink,
h5:hover .headerlink,
h6:hover .headerlink {
  visibility: visible;
}</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    </head>

    <body>
        <header class="navbar navbar-inverse bs-docs-nav">
            <div class="container-fluid">
                <div class="navbar-header">
		  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#theNavbar">
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span> 
		  </button>
                  <a class="navbar-brand" href="/" title="Home" class="title">Joris Van den Bossche</a>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation" id="theNavbar">
		    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/about.html" title="About">About</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div id="wrap">
<div class="container post">
    <article>
        <header>
            <h1>GeoPandas developments: redesign and improved performance using Cython</h1>
            <time datetime="article.date.isoformat()" pubdate>di 19 september 2017</time>
        </header>

        <div class="article_content">
            <p><em>This work is a collaboration with <a href="http://matthewrocklin.com/">Matthew Rocklin</a>. This blogpost shows our recent work on the GeoPandas library and is partly based on the <a href="https://www.youtube.com/watch?v=bWsA2R707BM">EuroSciPy talk</a> (<a href="https://jorisvandenbossche.github.io/talks/2017_EuroScipy_geopandas/#1">slides</a>) I recently gave on the same topic.</em></p>


<p>In this blogpost I explain the latest developments in the <a href="http://geopandas.readthedocs.io/en/latest/">GeoPandas</a> package. Work is ongoing to vastly improve the performance of the package, by leveraging cython to directly interact with the GEOS library.</p>


<p>Note: what I show here is <em>not yet</em> available in the released version of GeoPandas.</p>
<h2 id="what-is-geopandas-used-for">What is GeoPandas used for?<a class="headerlink" href="#what-is-geopandas-used-for" title="Permanent link">&para;</a></h2>
<!-- [intro]
Geospatial data analysis. Vector data. Open source libraries (GDAL/OGR, GEOS). Python stack. -->

<p>The goal of <a href="http://geopandas.readthedocs.io/en/latest/">GeoPandas</a> is to make working with geospatial data in python easier. GeoPandas extends the pandas data analysis library to work with tables of geospatially annotated data. GeoPandas enables you to easily do operations in python that would otherwise require a spatial database such as PostGIS.</p>
<p>GeoPandas combines the capabilities of pandas with Python's 'geospatial stack' (<a href="https://shapely.readthedocs.io/en/stable/">Shapely</a> to manage geometries like points, linestrings, and polygons; <a href="http://toblerity.org/fiona/">Fiona</a> to handle data import and export, ...). This stack consists of packages that provide intuitive Python wrappers around the OSGeo C/C++ libraries (GDAL/OGR, GEOS, ...) which power virtually every open source geospatial library or application, like PostGIS, QGIS, etc.</p>
<h3 id="small-demo">Small demo<a class="headerlink" href="#small-demo" title="Permanent link">&para;</a></h3>
<p>For example, we can use GeoPandas to load and plot the <a href="https://opendata.paris.fr/explore/dataset/quartier_paris/">Paris districts</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;quartier_paris.geojson&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>objectid</th>
      <th>c_qu</th>
      <th>l_qu</th>
      <th>c_ar</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>29</td>
      <td>47</td>
      <td>Bercy</td>
      <td>12</td>
      <td>POLYGON ((2.391141037839471 48.82611264577471,...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>41</td>
      <td>1</td>
      <td>St-Germain-l'Auxerrois</td>
      <td>1</td>
      <td>POLYGON ((2.344593389828428 48.85404991486192,...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>79</td>
      <td>76</td>
      <td>Combat</td>
      <td>19</td>
      <td>POLYGON ((2.388343313526396 48.88056667377272,...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>68</td>
      <td>65</td>
      <td>Ternes</td>
      <td>17</td>
      <td>POLYGON ((2.295039618663717 48.87377869547587,...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>50</td>
      <td>10</td>
      <td>Enfants-Rouges</td>
      <td>3</td>
      <td>POLYGON ((2.367101341254551 48.86162755885409,...</td>
    </tr>
  </tbody>
</table>
</div>

<p>Now, let's assume we want to know how many stations of the public bicycle sharing system Vélib (<a href="https://opendata.paris.fr/explore/dataset/stations-velib-disponibilites-en-temps-reel/information/">open data</a>) are located in each of the districts. For this, we also load the open data on the bicycle stations, and perform a <em>spatial join</em> with the districts dataframe:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># load the bicycle stations information</span>
<span class="n">stations</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;stations-velib-disponibilites-en-temps-reel.geojson&quot;</span><span class="p">)</span>
<span class="c1"># spatial join: determine in which district each stations is located</span>
<span class="n">stations</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;l_qu&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]],</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;within&#39;</span><span class="p">)</span>
<span class="c1"># count the number of stations per district, and add this information to the</span>
<span class="c1"># districts dataframe</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;l_qu&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;n_stations&#39;</span><span class="p">))</span>
<span class="c1"># calculate the relative number of bike stations divided by the area</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_stations_relative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_stations&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">area</span>
</code></pre></div>

<p>And now we can make a choropleth plot of the districts of Paris based on the number of bicycle stations:</p>
<div class="highlight"><pre><span></span><code><span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;n_stations_relative&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</code></pre></div>

<p><img src="https://jorisvandenbossche.github.io/figures/quartiers-paris-bike-stations.png"></p>
<p>A larger demo on the basic functionality of GeoPandas, expanding the example above, can be found in this <a href="http://nbviewer.jupyter.org/github/jorisvandenbossche/talks/blob/master/2017_EuroScipy_geopandas/geopandas_demo.ipynb">demo notebook</a> from my recent <a href="https://jorisvandenbossche.github.io/talks/2017_EuroScipy_geopandas/#1">EuroScipy presentation</a>.</p>
<h2 id="current-design-of-geopandas">Current design of GeoPandas<a class="headerlink" href="#current-design-of-geopandas" title="Permanent link">&para;</a></h2>
<p>Today a GeoDataFrame basically is a pandas dataframe with a special <code>object</code>-dtype column that
stores Shapely geometries (the 'geometry' column). Shapely geometries are Python objects that provide
a Python interface and reference to GEOS Geometry objects in C and provide all the spatial operations:</p>
<p><img src="https://jorisvandenbossche.github.io/images/geopandas-shapely-1.svg"
     width="50%"></p>
<p>The easy-to-use vectorized operations that GeoPandas provides, such as calculating the distance from every geometry in my dataframe to a certain point:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">some_point</span><span class="p">)</span>
</code></pre></div>

<p>are actually simply small wrappers around Python for loops over shapely calls. So the above method call is roughly implemented as the following:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">geom</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>

<p>Where each <code>geom</code> object in this iteration is an individual Shapely object, and the distance method of this Shapely objects calls into the GEOS library.</p>
<p>This simple design has made GeoPandas a very lightweight and easy-to-develop library, and is possible because GeoPandas can build upon the existing geospatial libraries. But, this simple design has also become a performance bottleneck.</p>
<h2 id="performance-bottleneck">Performance bottleneck<a class="headerlink" href="#performance-bottleneck" title="Permanent link">&para;</a></h2>
<p>GeoPandas is slow, which limits its usability for working with larger datasets. This slow performance is because of the current design of GeoPandas shown above: wrapping each geometry (like a point, line, or polygon) with a Shapely object, storing all of those objects in an object-dtype column, and iterating through those objects when performing spatial operations.</p>
<p>The iteration over the individual Shapely geometries is inefficient for two reasons:</p>
<ol>
<li>Iterating in Python is slow relative to iterating through those same objects in C.</li>
<li>Calling the geospatial operation on the Shapely Python object gives overhead compared to calling the underlying GEOS C operation directly.</li>
</ol>
<p>Additionally, the Shapely python objects can take up a significant amount of RAM relative to the GEOS Geometry objects that they wrap.</p>
<h4 id="some-timings">Some timings<a class="headerlink" href="#some-timings" title="Permanent link">&para;</a></h4>
<p>Let's explore this bad performance with a small benchmark:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">)])</span>
<span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
</code></pre></div>

<p>We have a GeoSeries of 100,000 points and a single polygon. For those objects we calculate the distance from all the points to the polygon, and whether each point lies within the polygon:</p>
<div class="highlight"><pre><span></span><code><span class="n">s</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
</code></pre></div>

<p>Both of these operations take roughly 1 second to compute.</p>
<p>This may not seem that much, but you have to be aware that geospatial datasets quickly become larger than 100,000 points, and that in more complex analyses those basic operations such as distance computations and set operations often are done many times.</p>
<p>Below, I also compare the performance of GeoPandas to <a href="http://postgis.net/">PostGIS</a>, the standard
geospatial plugin for the popular PostgreSQL database. While GeoPandas can often be as expressive as PostGIS, we will see that the current version of GeoPandas is also much slower than PostGIS.</p>
<h2 id="cythonizing-geopandas">Cythonizing GeoPandas<a class="headerlink" href="#cythonizing-geopandas" title="Permanent link">&para;</a></h2>
<p>Fortunately, we can improve upon this by accelerating GeoPandas using
Cython to perform the for loops in C and to call the underlying C library GEOS directly.</p>
<p>As an example, the distance function now looks like the following Cython implementation (some liberties taken for brevity):</p>
<div class="highlight"><pre><span></span><code><span class="n">cpdef</span> <span class="n">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
    <span class="n">cdef</span> <span class="n">double</span><span class="p">[:]</span> <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cdef</span> <span class="n">GEOSGeometry</span> <span class="o">*</span><span class="n">left_geom</span>
    <span class="n">cdef</span> <span class="n">GEOSGeometry</span> <span class="o">*</span><span class="n">right_geom</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">__geom__</span>  <span class="c1"># a geometry pointer</span>
    <span class="n">geometries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometry_array</span>

    <span class="k">with</span> <span class="n">nogil</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">left_geom</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GEOSGeometry</span> <span class="o">*&gt;</span> <span class="n">geometries</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">left_geom</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">GEOSDistance_r</span><span class="p">(</span><span class="n">left_geom</span><span class="p">,</span> <span class="n">some_point</span><span class="o">.</span><span class="n">__geom</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaN</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div>

<p>For a more complete example how to use Cython to interface directly with GEOS to speed-up shapely operations, see my <a href="https://jorisvandenbossche.github.io/blog/2017/03/18/vectorized-shapely-cython/">previous blogpost</a> on this topic.</p>
<h2 id="new-geopandas-design">New GeoPandas design<a class="headerlink" href="#new-geopandas-design" title="Permanent link">&para;</a></h2>
<p>To use such cython implementations of the spatial operations, we redesigned the internals of GeoPandas.
Instead of using a Pandas <code>object</code>-dtype column that <em>holds shapely objects</em>,
we instead store a NumPy array of <em>direct pointers to the GEOS objects</em> (images by Matthew Rocklin).</p>
<p><strong>Before</strong></p>
<p><img src="https://jorisvandenbossche.github.io/images/geopandas-shapely-1.svg"
     width="49%"></p>
<p><strong>After</strong></p>
<p><img src="https://jorisvandenbossche.github.io/images/geopandas-shapely-2.svg"
     width="49%"></p>
<p>This allows us to store data more efficiently, and also allows us to now
write our loops over these geometries in C or Cython.  When we perform bulk
vectorized operations on many GEOS pointers at once, dropping down to Cython
or C to write these loops directly provides a significant speedup.</p>
<p>To summarize, we created a numpy array-like object, which we call the <code>GeometryArray</code>, to hold geometry objects:</p>
<ul>
<li>It only stores integer pointers to the C GEOS geometry objects, without wrapping every geometry in Python shapely objects.</li>
<li>Operations on the array iterate through those pointers in C / Cython.</li>
<li>The geometries are wrapped into Python shapely objects on access.</li>
</ul>
<h2 id="new-benchmarks">New benchmarks<a class="headerlink" href="#new-benchmarks" title="Permanent link">&para;</a></h2>
<p>When we run the same simple benchmarks from <a href="#some-timings">above</a>, we get the following speed-up with the new implementation:</p>
<p><img src="https://jorisvandenbossche.github.io/figures/timings_distance_all.png" width="49%">
<img src="https://jorisvandenbossche.github.io/figures/timings_within_all.png" width="49%"></p>
<p>This shows a big improvement, depending on the exact operation. For the within operation, we get a 70x speed-up for this example.</p>
<!-- TODO exact numbers -->

<h4 id="comparison-to-postgis">Comparison to PostGIS<a class="headerlink" href="#comparison-to-postgis" title="Permanent link">&para;</a></h4>
<p>The above benchmarks are timings for basic operations, but let's see what speed-up we see for more complex operations.
To this end, I have taken an example of a spatial join from the <a href="http://workshops.boundlessgeo.com/postgis-intro/">Boundless PostGIS tutorial</a> (CC BY SA). <a href="http://postgis.net/">PostGIS</a> is the standard
geospatial plugin for the popular PostgreSQL database, and also uses the GEOS library under the hood.</p>
<p><strong>PostGIS Query</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- What is the population and racial make-up of the neighborhoods of Manhattan?</span>
<span class="k">SELECT</span><span class="w"></span>
<span class="w">  </span><span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">neighborhood_name</span><span class="p">,</span><span class="w"> </span><span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_total</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">population</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_white</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_total</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">white_pct</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_black</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="k">Sum</span><span class="p">(</span><span class="n">census</span><span class="p">.</span><span class="n">popn_total</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">black_pct</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">nyc_neighborhoods</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">neighborhoods</span><span class="w"></span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">nyc_census_blocks</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">census</span><span class="w"></span>
<span class="k">ON</span><span class="w"> </span><span class="n">ST_Intersects</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span><span class="w"> </span><span class="n">census</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">neighborhoods</span><span class="p">.</span><span class="n">name</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">white_pct</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<p><strong>GeoPandas Code</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">res</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">nyc_neighborhoods</span><span class="p">,</span> <span class="n">nyc_census_blocks</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;intersects&#39;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)[[</span><span class="s1">&#39;POPN_TOTAL&#39;</span><span class="p">,</span> <span class="s1">&#39;POPN_WHITE&#39;</span><span class="p">,</span> <span class="s1">&#39;POPN_BLACK&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;POPN_BLACK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;POPN_BLACK&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;POPN_TOTAL&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;POPN_WHITE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;POPN_WHITE&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;POPN_TOTAL&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;POPN_WHITE&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<p>The full code example can be found in <a href="https://github.com/jorisvandenbossche/talks/blob/master/2017_EuroScipy_geopandas/geopandas_postgis_comparison.ipynb">this notebook</a>. <strong>DISCLAIMER</strong>: this is just a dummy comparison and no real performance benchmark, and I am not a PostGIS expert.</p>
<p>Timing this spatial join with both PostGIS and the current and cythonized GeoPandas, we get the following result:</p>
<p><center>
<img src="https://jorisvandenbossche.github.io/figures/timings_sjoin_all.png">
</center></p>
<p>We can see that the new implementation gives a nice speed-up compared to the current GeoPandas, ánd is now also comparable to the performance of PostGIS.
This is not surprising because PostGIS is using the same GEOS library
internally.</p>
<h2 id="outlook">Outlook<a class="headerlink" href="#outlook" title="Permanent link">&para;</a></h2>
<p>In this blog post I have shown some promising results, but we have to emphasize this is still a work in progress and there is plenty of work to do. Some of the issues we have to tackle:</p>
<ul>
<li>Robust integration with pandas</li>
<li>Slow data ingestion (currently based on Fiona, wrapper around GDAL/OGR)</li>
<li>Re-implementing algorithms such as spatial overlays (spatial joins already done in C, directly interfacing GEOS and wrapped in cython to use in GeoPandas)</li>
<li>Battle testing!</li>
</ul>
<p>To elaborate on the first item about <em>integration with Pandas</em>: we need for Pandas to track our arrays of GEOS pointers differently from
how it tracks a normal integer array.  This is both for usability reasons, like
we want to render them differently and don't want users to be able to perform
numeric operations like sum and mean on these arrays, and also for stability
reasons, because we need to track these pointers and release their allocated
GEOSGeometry objects from memory at the appropriate times.</p>
<p>Currently, this
goal is pursued by creating a new block type, the <code>GeometryBlock</code> ('blocks' are
the internal building blocks of pandas that hold the data of the different columns).
This will require some changes to Pandas itself to enable custom block types
(see <a href="https://github.com/pandas-dev/pandas/issues/17144">this issue</a> on the pandas
issue tracker).</p>
<p>But next to the challenges, the cythonized GeoPandas version also promises: a speed-up, a memory improvement, and it makes it more feasible to experiment with using GeoPandas with Dask to <strong>parallelize or distribute geospatial analyses</strong>. See <a href="http://matthewrocklin.com/blog/work/2017/09/21/accelerating-geopandas-1">companion blogpost</a> of Matthew Rocklin for such an experiment.</p>
<!-- + opens up the ability to parallellize and distributed e.g. using dask (reference to Matthew's blogpost -> exploration of this) -->

<p>Last, the <code>GeometryArray</code> concept might be more broadly useful than just for GeoPandas. If you have such use cases, we would love to hear about that!</p>
<h3 id="trying-this-out">Trying this out!<a class="headerlink" href="#trying-this-out" title="Permanent link">&para;</a></h3>
<p>We would love you to try out the new cythonized GeoPandas version, test it on some real use cases and provide feedback.</p>
<p>Installing the new version currently requires building it from source with Cython. However, if you already have the released version of GeoPandas installed, Cython should be the only additional dependency (the GEOS library to build against should then already be installed). And in that case, the following steps should suffice:</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/geopandas/geopandas
git checkout geopandas-cython
make install
</code></pre></div>

<p>You can find more information and track future progress on this effort at
<a href="https://github.com/geopandas/geopandas/issues/473">geopandas/geopandas #473</a>. Also feedback can be posted there, and if you have troubles while trying it out, don't hesitate to ask questions at the <a href="https://gitter.im/geopandas/geopandas">geopandas gitter channel</a>.</p>
        </div>

        <div class="meta">
            <div>
                    <a href="https://jorisvandenbossche.github.io/tag/python.html" class="tag">python</a>
                    <a href="https://jorisvandenbossche.github.io/tag/geospatial.html" class="tag">geospatial</a>
                    <a href="https://jorisvandenbossche.github.io/tag/geopandas.html" class="tag">geopandas</a>
                    <a href="https://jorisvandenbossche.github.io/tag/shapely.html" class="tag">shapely</a>
            </div>
        </div>
    </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
    <script type="text/javascript">
      var disqus_shortname = 'jorisvandenbossche-blog';
      var disqus_identifier = '/blog/2017/09/19/geopandas-cython/';
      var disqus_url = 'https://jorisvandenbossche.github.io/blog/2017/09/19/geopandas-cython/';
      var disqus_title = 'GeoPandas developments: redesign and improved performance using Cython';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
  </section>

</div>

<style type="text/css">
{
    max-width: 700px;
}

.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
    min-width: 10ex;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
/*    max-width: 580px; */
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}

table.dataframe th, td {
    padding: 4px;
    text-align: left;
}

pre code {
    background-color: inherit;
}</style>

        </div>
<!--
    <footer>
      <p>
        © 2012-2017 Joris Van den Bossche, license <a href=""> </a>
        unless otherwise noted.
        Generated by <a href= "http://docs.getpelican.com/">Pelican</a>.
      </p>
    </footer>
-->
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-106868563-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-106868563-1');
    ga('send', 'pageview');
</script>
    </body>
</html>